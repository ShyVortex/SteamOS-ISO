name: Create Ventoy-patched Recovery IMG

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install host deps
        run: |
          sudo apt-get update
          sudo apt-get install -y bzip2 curl

      # 1) Download & decompress the raw image
      - name: Fetch SteamOS recovery image
        run: |
          curl -sSL https://steamdeck-images.steamos.cloud/recovery/steamdeck-repair-latest.img.bz2 \
            -o steamos-recovery.img.bz2
          bunzip2 steamos-recovery.img.bz2
          mv steamos-recovery.img recovery.img

      # 2) Run Arch container to inject the steamimg hook and rebuild initramfs
      - name: Inject Ventoy hook & rebuild initramfs
        run: |
          docker run --rm \
          --privileged \
          -v "${{ github.workspace }}:/work" \
          archlinux:latest \
          /work/scripts/ventoy_hook.sh

      # 3) Split into <2GiB chunks
      - name: Split for GitHub release
        run: |
          # chunk size 1900M, 3-digit numeric suffixes
          split --numeric-suffixes=1 --suffix-length=3 --bytes=1900M \
            recovery.img steamos-recovery.img.part-
          ls -lh steamos-recovery.img.part-*

      # 4) Publish all parts as release assets
      - name: Create & upload GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: SteamOS ${{ steps.version.outputs.version }}
          # glob will catch part-001, part-002, â€¦
          files: steamos-recovery.img.part-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
